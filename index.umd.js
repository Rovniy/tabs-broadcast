(function(i,e){typeof exports=="object"&&typeof module<"u"?module.exports=e():typeof define=="function"&&define.amd?define(e):(i=typeof globalThis<"u"?globalThis:i||self).TabsBroadcast=e()})(this,function(){"use strict";var L=Object.defineProperty;var _=i=>{throw TypeError(i)};var B=(i,e,n)=>e in i?L(i,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):i[e]=n;var P=(i,e,n)=>B(i,typeof e!="symbol"?e+"":e,n),E=(i,e,n)=>e.has(i)||_("Cannot "+n);var a=(i,e,n)=>(E(i,e,"read from private field"),n?n.call(i):e.get(i)),m=(i,e,n)=>e.has(i)?_("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,n),d=(i,e,n,f)=>(E(i,e,"write to private field"),f?f.call(i,n):e.set(i,n),n),y=(i,e,n)=>(E(i,e,"access private method"),n);var T,g,w,v,b,l,r,h,C,O,p,k,x;const i={channelName:"xploit_tab_channel",layer:"default_layer",listenOwnChannel:!0,emitByPrimaryOnly:!0,onBecomePrimary:()=>{}},e={tab_prefix:"xploit_tab_id_",slave:"xploit_slave",primary:"xploit_primary",primaryTabId:"xploit_primary_tab_id",primaryStatusChanged:"XPLOIT_TAB_STATUS_CHANGED"};class n{constructor(){P(this,"tabId");this.tabId=e.tab_prefix+Date.now().toString(),this.init()}init(){if(typeof window>"u")return;const t=()=>{localStorage.getItem(e.primaryTabId)?this.setSlaveTab(this.tabId):this.setPrimaryTab(this.tabId),this.notifyTabStatus()};document.readyState==="complete"?t():window.addEventListener("load",t),window.addEventListener("pagehide",()=>{this.isPrimaryTab()&&(this.removeTabStatus(e.primaryTabId),this.transferPrimaryStatus()),this.removeTabStatus(this.tabId)}),window.addEventListener("storage",s=>{s.key===e.primaryTabId&&this.notifyTabStatus()})}set(t,s){localStorage.setItem(t,s)}get(t){return localStorage.getItem(t)}remove(t){localStorage.removeItem(t)}setPrimaryTab(t){this.set(e.primaryTabId,t),this.set(t,e.primary)}setSlaveTab(t){this.set(t,e.slave)}transferPrimaryStatus(){const t=Object.keys(localStorage).filter(s=>s!==e.primaryTabId&&this.get(s)===e.slave);t.length>0?this.setPrimaryTab(t.at(0)):this.remove(e.primaryTabId)}removeTabStatus(t){this.remove(t)}notifyTabStatus(){if(typeof window>"u")return;const t={detail:{tabId:this.tabId,isPrimary:this.isPrimaryTab()}};window.dispatchEvent(new CustomEvent(e.primaryStatusChanged,t))}isPrimaryTab(){return this.get(e.primaryTabId)===this.tabId}}const u=class u{constructor(t=null){m(this,h);m(this,T);m(this,g);m(this,w);m(this,v);m(this,b);m(this,l);m(this,r);P(this,"primary",!1);if(u.instance)return u.instance;this.setConfig(t),y(this,h,C).call(this),u.instance=this}on(t,s,o=i.layer){y(this,h,p).call(this,o).listeners.push({type:t,callback:s,once:!1})}onList(t){t.length&&t.forEach(([s,o,c])=>{s&&o&&y(this,h,p).call(this,c).listeners.push({type:s,callback:o})})}once(t,s,o){y(this,h,p).call(this,o).listeners.push({type:t,callback:s,once:!0})}onceList(t){t.length&&t.forEach(([s,o,c=i.layer])=>{s&&o&&y(this,h,p).call(this,c).listeners.push({type:s,callback:o,once:!0})})}off(t,s=null){if(s)a(this,r)[s].listeners.filter(o=>o.type!==t);else for(const o in a(this,r))a(this,r)[o].listeners.filter(c=>c.type!==t)}deleteLayer(t){y(this,h,p).call(this,t).listeners=[],a(this,r)[t]=null,delete a(this,r)[t]}emit(t,s=null,o=i.layer){a(this,v)&&!a(this,b).isPrimaryTab()||a(this,l)&&(Array.isArray(o)?o:[o]).forEach(c=>{y(this,h,p).call(this,c);const S={type:t,payload:s,layer:c};a(this,l).postMessage(S),a(this,g)&&a(this,l).onmessage({data:S})})}isPrimary(){return a(this,b).isPrimaryTab()}setConfig(t){const s={...i,...t};d(this,T,s.channelName),d(this,r,{}),d(this,g,s.listenOwnChannel),d(this,w,s.onBecomePrimary),d(this,v,s.emitByPrimaryOnly)}async destroy(t=0){try{t>0&&await new Promise(s=>setTimeout(s,t)),a(this,l)&&(a(this,l).close(),d(this,l,null)),a(this,r)&&(Object.keys(a(this,r)).forEach(s=>{a(this,r)[s].listeners=[]}),d(this,r,{})),u.instance=null}catch(s){console.error("TabsBroadcast: Error while destroying instance:",s)}}getEvents(){return Object.keys(a(this,r)).length===1&&a(this,r)[i.layer]?[...a(this,r)[i.layer].listeners]:Object.values(a(this,r)).reduce((t,s)=>t=[...t,...s.listeners],[])}getLayers(){return Object.keys(a(this,r))}use(t){t(this)}};T=new WeakMap,g=new WeakMap,w=new WeakMap,v=new WeakMap,b=new WeakMap,l=new WeakMap,r=new WeakMap,h=new WeakSet,C=function(){window&&(d(this,b,new n),d(this,l,new BroadcastChannel(a(this,T))),a(this,l).onmessage=y(this,h,k).bind(this),a(this,l).onmessageerror=y(this,h,x).bind(this),this.primary=!1,y(this,h,O).call(this))},O=function(){window.addEventListener(e.primaryStatusChanged,t=>{const s=t;a(this,b).isPrimaryTab()?(this.primary=!0,a(this,w).call(this,s.detail)):this.primary=!1},{passive:!0})},p=function(t=i.layer){return a(this,r)[t]||(a(this,r)[t]={name:t,listeners:[]}),a(this,r)[t]},k=function(t){const{type:s,payload:o,layer:c}=t.data,S=y(this,h,p).call(this,c);S.listeners=S.listeners.filter(I=>I.type!==s&&I.type!=="*"||(I.callback({type:s,payload:o,layer:c}),!I.once))},x=function(t){process.env.NODE_ENV!=="production"&&console.error("Can't parse message",t)},P(u,"instance");let f=u;return f});
//# sourceMappingURL=index.umd.js.map
